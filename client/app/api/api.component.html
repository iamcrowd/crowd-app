<div id="api-container" class="d-flex flex-row">
  <div class="side-menu d-flex flex-row flex-shrink-0">
    <ul class="nav nav-pills nav-flush flex-column mb-auto text-center">
      <li *ngFor="let api of apis  | keyvalue" [title]="api.value.description">
        <a class="side-btn btn nav-link py-3 border-bottom" [class.active]="selectedAPI == api.key"
          (click)="setAPI(api.key)">
          <i class="fa fa-fw fa-{{api.value.icon}} fa-2x"></i><br>
          {{api.value.name}}
        </a>
      </li>
    </ul>
  </div>
  <div class="secondary-side-menu d-flex flex-column">
    <ul class="nav nav-pills nav-flush flex-column mb-auto text-center">
      <li>
        <a *ngFor="let endpoint of apis[selectedAPI].endpoints | keyvalue"
          class="side-btn btn nav-link py-3 border-bottom" [title]="endpoint.value.description"
          (click)="setEndpoint(endpoint.key)">
          <span class="call-type">{{endpoint.value.type}}</span> {{endpoint.value.name}}
        </a>
      </li>
    </ul>
  </div>
  <div class="central-menu d-flex flex-column" style="width: 100%; height: 100%;">
    <div class="tabs d-flex flex-row">
      <div *ngFor="let tab of tabs; let index = index" class="tab btn" (click)="setTab(index)"
        [class.tab-active]="selectedTab == index">
        <div class="d-flex flex-row">
          <div class="tab-name" *ngIf="tab.api != null">
            <span class="call-type">{{apis[tab.api].endpoints[tab.endpoint].type}}</span>
            {{apis[tab.api].endpoints[tab.endpoint].name}}
          </div>
          <div class="tab-name" *ngIf="tab.api == null">
            New Tab
          </div>
          <div>
            <i class="tab-delete fa fa-fw fa-times" (click)="$event.stopPropagation(); removeTab(index)"></i>
          </div>
        </div>
      </div>
      <div class="tab new-tab btn" (click)="newTab()">
        <i class="fa fa-fw fa-plus"></i>
      </div>
    </div>
    <div class="tab-content d-flex flex-row">
      <div *ngFor="let tab of tabs; let index = index" class="tab-pane" [class.active]="selectedTab == index">
        <div *ngIf="!tab.api" class="text-center d-flex flex-row align-items-center justify-content-center"
          style="width: 100%; height: 100%;">
          <div style="width: 5rem;">
            <i class="fa fa-file-o fa-5x"></i>
          </div>
          <div style="width: 10rem;">
            This is a new tab.
            <b>Please select an API and an endpoint to make a query.</b>
          </div>
        </div>
        <div *ngIf="tab.api" class="d-flex flex-row" style="width: 100%; height: 100%;">
          <div class="d-flex flex-column" style="width: 100%; height: 100%;">
            <div class="tab-pane-entry d-flex flex-column">
              <div class="flex-grow-1">
                <label class="tab-url float-right">
                  <i class="fa fa-fw fa-link"></i>
                  {{apis[tab.api].endpoints[tab.endpoint].url ? apis[tab.api].endpoints[tab.endpoint].url :
                  apis[tab.api].service.config.url}}{{apis[tab.api].endpoints[tab.endpoint].method ?
                  apis[tab.api].endpoints[tab.endpoint].method : ''}}
                </label>
                <h3>Input</h3>
                <div style="height: calc(100% - 2.5rem);">
                  <span [ngSwitch]="tab.api">
                    <span *ngSwitchCase="'metamodel'">
                      <span [ngSwitch]="tab.endpoint">
                        <span *ngSwitchCase="6">
                          <ng-container [ngTemplateOutlet]="metatoowl"
                            [ngTemplateOutletContext]="{ tab: tab, index: index }">
                          </ng-container>
                        </span>
                        <span *ngSwitchDefault>
                          <ng-container [ngTemplateOutlet]="editorModel"
                            [ngTemplateOutletContext]="{ tab: tab, index: index, parameter: 'data' }">
                          </ng-container>
                        </span>
                      </span>
                    </span>
                    <span *ngSwitchCase="'reasoning'">
                      <ng-container [ngTemplateOutlet]="reasoning"
                        [ngTemplateOutletContext]="{ tab: tab, index: index }">
                      </ng-container>
                    </span>
                    <span *ngSwitchCase="'test'">
                      <span [ngSwitch]="tab.endpoint">
                        <span *ngSwitchCase="0">
                          <ng-container [ngTemplateOutlet]="owltometa"
                            [ngTemplateOutletContext]="{ tab: tab, index: index }">
                          </ng-container>
                        </span>
                      </span>
                    </span>
                  </span>
                </div>
              </div>
              <div class="tab-pane-send flex-shrink-0">
                <button class="btn btn-primary" (click)="send(index)">Send</button>
              </div>
            </div>
            <div class="tab-pane-output d-flex flex-column" [style.height]="tab.showOutput ? '100%' : '3rem'">
              <div class="flex-grow-1">
                <button *ngIf="tab.output" class="toggle-menu-btn btn float-right" (click)="toggleOutput(index)">
                  <i class="fa fa-fw fa-chevron-{{tab.showOutput ? 'down' : 'up'}}"></i>
                </button>
                <i class="fa fa-fw fa-spinner fa-pulse fa-2x float-right" *ngIf="tab.loadingOutput"></i>
                <h3>Output <button *ngIf="tab.showOutput && ['reasoning', 'test'].includes(tab.api)"
                    class="btn btn-sm btn-secondary" (click)="tab.parameters.raw = !tab.parameters.raw"
                    tippy="Toggle raw data view">
                    <i class="fa fa-fw fa-file-code-o"></i>
                  </button>
                </h3>
                <div style="height: calc(100% - 5rem);">
                  <span *ngIf="tab.output">
                    <span *ngIf="tab.api == 'metamodel' && tab.endpoint == 6">
                      <ng-container [ngTemplateOutlet]="editorModel"
                        [ngTemplateOutletContext]="{ tab: tab, index: index, output: true, fullHeight: true, mode: 'xml' }">
                      </ng-container>
                    </span>
                    <span *ngIf="tab.api == 'reasoning'">
                      <span *ngIf="tab.parameters.raw">
                        <ng-container [ngTemplateOutlet]="editorModel"
                          [ngTemplateOutletContext]="{ tab: tab, index: index, output: true, fullHeight: true, label: 'Reasoning' }">
                        </ng-container>
                      </span>
                      <span *ngIf="!tab.parameters.raw">
                        <div class="row flex-shrink-0">
                          <div class="col collapse-buttons">
                            <button class="btn" *ngFor="let output of tab.output  | keyvalue"
                              [class.active]="tab.parameters.outputTab == output.key"
                              (click)="tab.parameters.outputTab = output.key">{{output.key}}</button>
                          </div>
                        </div>
                        <div class="flex-grow-1 h-100 collapse-container">
                          <span *ngFor="let output of tab.output  | keyvalue">
                            <ng-container [ngTemplateOutlet]="editorModel"
                              *ngIf="tab.parameters.outputTab == output.key"
                              [ngTemplateOutletContext]="{ tab: tab, index: index, output: true, parameter: output.key, label: '‎', notOpen: output.key != 'KF' }">
                            </ng-container>
                          </span>
                        </div>
                      </span>
                    </span>
                    <span *ngIf="tab.api == 'test' && tab.endpoint == 0">
                      <span *ngIf="tab.parameters.raw">
                        <ng-container [ngTemplateOutlet]="editorModel"
                          [ngTemplateOutletContext]="{ tab: tab, index: index, output: true, fullHeight: true, label: 'KF' }">
                        </ng-container>
                      </span>
                      <span *ngIf="!tab.parameters.raw">
                        <div class="row flex-shrink-0">
                          <div class="col collapse-buttons">
                            <button class="btn" *ngFor="let output of tab.output  | keyvalue"
                              [class.active]="tab.parameters.outputTab == output.key"
                              (click)="tab.parameters.outputTab = output.key">{{output.key}}</button>
                          </div>
                        </div>
                        <div class="flex-grow-1 h-100 collapse-container">
                          <span *ngFor="let output of tab.output  | keyvalue">
                            <ng-container [ngTemplateOutlet]="editorModel"
                              *ngIf="tab.parameters.outputTab == output.key"
                              [ngTemplateOutletContext]="{ tab: tab, index: index, output: true, parameter: output.key, label: '‎', notOpen: output.key != 'kf' }">
                            </ng-container>
                          </span>
                        </div>
                      </span>
                    </span>
                    <span
                      *ngIf="!(tab.api == 'metamodel' && tab.endpoint == 6) && !(tab.api == 'reasoning') && !(tab.api == 'test' && tab.endpoint == 0)">
                      <ng-container [ngTemplateOutlet]="editorModel"
                        [ngTemplateOutletContext]="{ tab: tab, index: index, output: true, fullHeight: true }">
                      </ng-container>
                    </span>
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane-metrics d-flex flex-row" [style.flexBasis]="tab.showMetrics ? '35%' : '1.5rem'">
            <div class="d-flex align-items-center" style="width: 1.5rem;">
              <button class="toggle-menu-btn toggle-menu-btn-large btn p-0 w-100 h-100" (click)="toggleMetrics(index)">
                <i class="fa fa-fw fa-chevron-{{tab.showMetrics ? 'right' : 'left'}}"></i>
              </button>
            </div>
            <div *ngIf="tab.showMetrics" class="metrics-container flex-grow-1">
              <h3 class="text-center">Metrics</h3>
              <div *ngIf="!tab.output?.metrics" class="text-center text-muted">
                No metrics available.
              </div>
              <div *ngIf="tab.output?.metrics" class="metrics-list">
                <div *ngFor="let metric of tab.output.metrics | keyvalue" class="metric">
                  <label class="font-weight-bold key">{{fromInfix(metric.key)}}</label><br />
                  <label style="padding-left: 1rem;">{{metric.value}}</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #editorModel let-tab='tab' let-index='index' let-parameter='parameter' let-mode='mode'
  let-serialize='serialize' let-output='output' let-label='label' let-fullHeight='fullHeight' let-notOpen='notOpen'>
  <label>
    {{label ? label : apis[tab.api].endpoints[tab.endpoint].parameters[output ? 'to' : 'from'].toUpperCase()}}
  </label>&nbsp;
  <button *ngIf="!output && apis[tab.api].endpoints[tab.endpoint].example"
    class="example-btn btn btn-sm btn-warning font-weight-bold"
    (click)="loadExample(index, parameter, serialize)">EXAMPLE</button>
  <button class="btn btn-secondary btn-sm float-right" ngxClipboard
    [cbContent]="output ? JSON.stringify(tab.output, null, '\t') : tab.parameters[parameter]" tippy="Copy to Clipboard">
    <i class="fa fa-fw fa-clipboard"></i>
  </button>
  <button class="btn btn-secondary btn-sm float-right"
    *ngIf="!notOpen && this.apis[tab.api].endpoints[tab.endpoint].openIn[output ? 1 : 0] != null" (click)="openInEditor(this.apis[tab.api].endpoints[tab.endpoint].openIn[output ? 1 : 0],
    this.apis[tab.api].endpoints[tab.endpoint].parameters[output ? 'to' : 'from'],
    index, output ? tab.output : tab.parameters[parameter], !output, output)" tippy="Open in Editor"
    style="margin-right: 0.5rem;">
    <i class="fa fa-fw fa-th"></i>
  </button>
  <ngx-codemirror *ngIf="!output" [(ngModel)]="tab.parameters[parameter]" [options]="{
    theme: 'duotone-' + (this.darkmodeService.isDarkMode() ? 'dark' : 'light'),
    mode: !mode ? { name: 'javascript', json: true } : mode,
    lineNumbers: true,
    lineWrapping: true,
    foldGutter: true,
    gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter', 'CodeMirror-lint-markers'],
    autoCloseBrackets: true,
    matchBrackets: true,
    readOnly: false
  }">
  </ngx-codemirror>
  <ngx-codemirror *ngIf="output" [class.codemirror-full-height]="fullHeight" ngModel="{{apis[tab.api].endpoints[tab.endpoint].response == 'xml'
    ? (parameter ? tab.output[parameter] : tab.output )
    : JSON.stringify((parameter ? tab.output[parameter] : tab.output ), null, '\t') }}" [options]="{
      theme: 'duotone-' + (this.darkmodeService.isDarkMode() ? 'dark' : 'light'),
      mode: !mode ? { name: 'javascript', json: true } : mode,
      lineNumbers: false,
      lineWrapping: true,
      foldGutter: true,
      gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter', 'CodeMirror-lint-markers'],
      autoCloseBrackets: true,
      matchBrackets: true,
      readOnly: true
    }">
  </ngx-codemirror>
</ng-template>

<ng-template #metatoowl let-tab='tab' let-index='index'>
  <div class="d-flex flex-column h-100 w-100">
    <div class="row flex-shrink-0" style="padding-bottom: 1rem;">
      <div class="col-6">
        <label>Encoding</label>
        <select class="form-control custom-select my-1 mr-sm-2" [(ngModel)]="tab.parameters.format">
          <option value="owl2-alcqi" selected>OWL2 - ALCQI</option>
          <option value="owllink-alcqi">OLWLink - ALCQI</option>
        </select>
      </div>
      <div *ngIf="tab.parameters.format == 'owl2-alcqi'" class="col-6">
        <label>Syntax</label>
        <select class="form-control custom-select my-1 mr-sm-2" [(ngModel)]="tab.parameters.syntax">
          <option value="rdfxml" selected>RDF/XML</option>
          <option value="owlxml">OWL/XML</option>
          <option value="turtle">Turtle</option>
          <option value="ntriples">N-Triples</option>
          <option value="manchester">Manchester</option>
          <option value="functional">Functional</option>
        </select>
      </div>
    </div>
    <div class="flex-grow-1 h-100">
      <ng-container [ngTemplateOutlet]="editorModel"
        [ngTemplateOutletContext]="{ tab: tab, index: index, parameter: 'data' }">
      </ng-container>
    </div>
  </div>
</ng-template>

<ng-template #owltometa let-tab='tab' let-index='index'>
  <div class="d-flex flex-column h-100 w-100">
    <div class="row flex-shrink-0" style="padding-bottom: 0.5rem;">
      <div class="col">
        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" [(ngModel)]="tab.parameters.reasoning"
            id="reasoning-switch">
          <label class="custom-control-label" for="reasoning-switch">Reasoning</label>
        </div>
      </div>
    </div>
    <div class="row flex-shrink-0">
      <div class="col collapse-buttons">
        <button class="btn" [class.active]="tab.parameters.input == 'string'"
          (click)="tab.parameters.input = 'string'">String</button>
        <button class="btn" [class.active]="tab.parameters.input == 'uri'"
          (click)="tab.parameters.input = 'uri'">URI</button>
        <button class="btn" [class.active]="tab.parameters.input == 'files'"
          (click)="tab.parameters.input = 'files'">Files</button>
      </div>
    </div>
    <div class="flex-grow-1 h-100 collapse-container" [ngSwitch]="tab.parameters.input">
      <span *ngSwitchCase="'string'">
        <ng-container [ngTemplateOutlet]="editorModel"
          [ngTemplateOutletContext]="{ tab: tab, index: index, parameter: 'ontologyString', mode: 'xml', serialize: false }">
        </ng-container>
      </span>
      <span *ngSwitchCase="'uri'">
        <div class="col-xl-6">
          <label>URI</label>
          <input class="form-control" [(ngModel)]="tab.parameters.ontologyUri"
            placeholder="http://www.w3.org/2006/time#" />
        </div>
        <div class="col" style="padding-top: 0.75rem; height: calc(100% - 2.5rem);">
          <label>Examples</label>
          <div style=" overflow-y: auto; overflow-x: hidden; height: calc(100% - 4.5rem);">
            <div class="card-deck">
              <div *ngFor="let uri of examples.uris" class="btn card bg-warning text-white text-center p-2"
                style="width: 4rem; min-width: 4rem; max-width: 4rem; margin-bottom: 1rem;"
                (click)="loadExample(index, 'ontologyUri', false, uri.url)" [tippy]="uri.url" [maxWidth]="'none'">
                <blockquote class="blockquote mb-0">
                  {{uri.emoji}}
                </blockquote>
              </div>
            </div>
          </div>
        </div>
      </span>
      <span *ngSwitchCase="'files'">
        <!-- <input ngf multiple type="file" accept="owl/*" [(files)]="tab.parameters.ontologiesFiles" maxSize="1024"
          capturePaste="1" /> -->
        <div ngfDrop class="btn owltometa-files-drop mb-2" selectable="1" multiple="1"
          [(files)]="tab.parameters.ontologiesFiles" [(dragFiles)]="dragFiles" [(invalidDrag)]="invalidDrag"
          [ngClass]="{ 'valid-drag': dragFiles, 'invalid-drag': invalidDrag }" [capturePaste]="true" accept="*.owl">
          Select/Drop your OWL files here
        </div>

        <h3>{{ tab.parameters.ontologiesFiles.length }} Files <button class="btn btn-sm btn-danger"
            (click)="tab.parameters.ontologiesFiles = []" tippy="Clear All">
            <i class="fa fa-fw fa-trash"></i>
          </button>
        </h3>
        <div style="height: calc(100% - 7rem); overflow-y: auto;">
          <table class="table owltometa-files-table">
            <thead>
              <tr>
                <th>Name</th>
                <th style="width: 7rem;">Size</th>
                <th style="width: 5rem;"></th>
              </tr>
            </thead>
            <tbody>
              <tr class="owltometa-file-row" *ngFor="let item of tab.parameters.ontologiesFiles; let i=index">
                <td>
                  <div *ngIf="['image/gif','image/png','image/jpeg'].indexOf(item.type)>=0">
                    <div class="previewIcon" [ngfBackground]="item"></div>
                  </div>
                  <strong>{{ item.name }}</strong>
                </td>
                <td nowrap>
                  {{ item.size/1024/1024 | number:'.2' }} MB
                </td>
                <td class="text-right" nowrap>
                  <button type="button" class="btn btn-sm btn-danger btn-xs"
                    (click)="tab.parameters.ontologiesFiles.splice(i, 1)" tippy="Remove">
                    <i class="fa fa-fw fa-times"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </span>
    </div>
  </div>
</ng-template>

<ng-template #reasoning let-tab='tab' let-index='index'>
  <div class="d-flex flex-column h-100 w-100">
    <div class="row flex-shrink-0" style="padding-bottom: 1rem;">
      <div class="col">
        <label>Reasoner</label>
        <select class="form-control custom-select my-1 mr-sm-2" [(ngModel)]="tab.parameters.reasoner">
          <option value="Racer">Racer</option>
          <option value="Konclude">Konclude</option>
        </select>
      </div>
      <div class="col">
        <label>Encoding</label>
        <select class="form-control custom-select my-1 mr-sm-2" [(ngModel)]="tab.parameters.strategy">
          <option value="alcqi" selected>ALCQI</option>
        </select>
      </div>
    </div>
    <div class="row flex-shrink-0" style="padding-bottom: 1rem;">
      <div class="col">
        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" [(ngModel)]="tab.parameters.cards" id="cards-switch">
          <label class="custom-control-label" for="cards-switch">Reason Cardinalities</label>
          <i class="btn btn-sm fa fa-fw fa-info-circle" [tippy]="cards_warning" placement="right"></i>
        </div>
        <ng-template #cards_warning>
          <span class="text-muted">(this may take too much time)</span><br>
          <span class="text-danger">(this will replace the current cardinalities with the inferred ones)</span>
        </ng-template>
      </div>
    </div>
    <div class="flex-grow-1 h-100">
      <ng-container [ngTemplateOutlet]="editorModel"
        [ngTemplateOutletContext]="{ tab: tab, index: index, parameter: 'kf' }">
      </ng-container>
    </div>
  </div>
</ng-template>
